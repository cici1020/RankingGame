<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ’åºæŒ‘æˆ˜ - è½»æ¾å‡ºé¢˜</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* === å…¨å±€æ ·å¼ === */
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f4f6f8; color: #333; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* æŒ‰é’® */
        button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0069d9; }
        .btn-outline { background: transparent; border: 2px dashed #cbd5e0; color: #4a5568; }
        .btn-outline:hover { border-color: #007bff; color: #007bff; background: #f8fbff; }
        
        input[type="text"] { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        /* === å‡ºé¢˜åŒºåŸŸæ ·å¼ === */
        #creator-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .upload-card { background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid #eee; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column;}
        
        /* ç¼©ç•¥å›¾ */
        .thumb-box { height: 140px; width: 100%; background: #eee; position: relative; cursor: grab; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* åˆ é™¤æŒ‰é’® (å³ä¸Šè§’çº¢å‰) */
        .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 24px; cursor: pointer; font-size: 14px; z-index: 10;}
        .delete-btn:hover { background: #dc3545; }

        /* åºå·æ ‡ç­¾ */
        .index-badge { position: absolute; top: 5px; left: 5px; background: rgba(0,123,255,0.9); color: white; font-size: 12px; padding: 2px 8px; border-radius: 10px; z-index: 10; }

        /* åº•éƒ¨è¾“å…¥æ¡† */
        .input-area { padding: 8px; border-top: 1px solid #f0f0f0; }
        .input-area input { margin: 0; padding: 8px; font-size: 13px; width: 100%; border: 1px solid #eee; }

        /* === ç©å®¶åŒºåŸŸæ ·å¼ === */
        #game-area { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .game-item { position: relative; cursor: grab; border-radius: 8px; overflow: hidden; background: #fff; aspect-ratio: 1; border: 4px solid transparent; }
        .game-item img { width: 100%; height: 100%; object-fit: cover; }
        .game-item.correct { border-color: #28a745; }
        .game-item.wrong { border-color: #dc3545; }

        .hidden { display: none !important; }
        #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>

    <div id="loading" class="hidden">
        <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
        <div>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
    </div>

    <div id="main-panel">
        
        <div id="creator-panel" class="card hidden">
            <h3 style="margin-top:0; text-align:center;">ğŸ“· æ¬¢è¿å‡ºé¢˜</h3>
            
            <label style="font-weight:bold;">æ¸¸æˆæ ‡é¢˜</label>
            <input type="text" id="game-title" placeholder="ä¾‹å¦‚ï¼šçŒœçŒœè¿™æ˜¯å“ªä¸€å¹´ï¼Ÿ">

            <div style="margin-top: 20px;">
                <label style="font-weight:bold;">å·²é€‰å›¾ç‰‡ (å¯æ‹–æ‹½æ’åº)</label>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">è¯·æŒ‰ç…§æ­£ç¡®çš„æ—¶é—´/é€»è¾‘é¡ºåºæ’åˆ—å›¾ç‰‡</div>
                
                <div id="creator-grid"></div>

                <input type="file" id="hidden-file-input" multiple accept="image/*" style="display:none" onchange="handleFileSelect(this)">
                
                <button class="btn-outline" onclick="document.getElementById('hidden-file-input').click()" style="margin-top:15px;">
                    â• æ·»åŠ å›¾ç‰‡ (æ”¯æŒå¤šæ¬¡é€‰æ‹©ï¼Œæœ€å¤š10å¼ )
                </button>
            </div>

            <div style="margin-top:30px; border-top: 1px solid #eee; padding-top:20px;">
                <div id="status-bar" style="text-align:center; margin-bottom:10px; font-size:14px; color:#666;">å½“å‰å·²é€‰ 0 å¼  (æœ€å°‘3å¼ )</div>
                <button class="btn-primary" onclick="createGame()">ğŸš€ ç”Ÿæˆå¹¶åˆ†äº«</button>
            </div>
        </div>

        <div id="player-panel" class="card hidden">
            <h2 id="play-title" style="text-align:center; margin-bottom:10px;"></h2>
            <p style="text-align:center; color:#666; margin-top:0;">ğŸ‘‡ æ‹–æ‹½å›¾ç‰‡è¿˜åŸé¡ºåº ğŸ‘‡</p>
            <div id="game-area"></div>
            <button id="submit-btn" class="btn-primary" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
            <button id="retry-btn" class="btn-primary hidden" onclick="retryGame()" style="background:#6c757d;">å†è¯•ä¸€æ¬¡</button>
            <div id="result-msg" style="text-align:center; margin-top:15px; font-weight:bold; font-size:18px;"></div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ (V9 æœ€ç»ˆé…ç½®) =================
        // è¿™æ˜¯ä½ çš„ Supabase URL å’Œ Anon Keyï¼ŒAnon Keyæ˜¯å…¬å¼€çš„ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚
        const SUPABASE_URL = 'https://nhyolnegjehxapmvypxc.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_28A4O_S-QsO8BBOj667ocw_ZYTlbQwS';
        // ------------------------------------------------------------

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const params = new URLSearchParams(window.location.search);
        const gameId = params.get('id');

        // å…¨å±€å˜é‡ï¼šæš‚å­˜ç”¨æˆ·é€‰æ‹©çš„ **å‹ç¼©å** çš„ Blob å¯¹è±¡
        let selectedImages = []; 

        // === åˆå§‹åŒ–ï¼šåˆ¤æ–­æ˜¯å‡ºé¢˜è¿˜æ˜¯ç©å®¶æ¨¡å¼ ===
        (function init() {
            if (gameId) {
                // ç©å®¶æ¨¡å¼
                loadGame(gameId);
            } else {
                // å‡ºé¢˜æ¨¡å¼
                showCreatorUI();
            }
        })();
        
        // === é€šç”¨å·¥å…·å‡½æ•° ===
        function toggleLoading(show) { 
            document.getElementById('loading').className = show ? '' : 'hidden'; 
        }

        // === å›¾ç‰‡å‹ç¼©é€»è¾‘ (V7 ä¼˜åŒ–) ===
        function compressImage(file, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // ä¿æŒå®½é«˜æ¯”
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // å°† Canvas å†…å®¹å¯¼å‡ºä¸º Blobï¼Œç»Ÿä¸€ä½¿ç”¨ JPEG æ ¼å¼è¿›è¡Œå‹ç¼©
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error("Canvas to Blob conversion failed."));
                            }
                        }, 'image/jpeg', quality); 
                    };
                    img.onerror = (e) => reject(e);
                };
                reader.onerror = (e) => reject(e);
            });
        }

        // === å‡ºé¢˜ç•Œé¢é€»è¾‘ ===
        function showCreatorUI() {
            document.getElementById('creator-panel').classList.remove('hidden');
            renderCreatorGrid();
            new Sortable(document.getElementById('creator-grid'), {
                animation: 150,
                handle: '.thumb-box',
                onEnd: function (evt) {
                    const item = selectedImages.splice(evt.oldIndex, 1)[0];
                    selectedImages.splice(evt.newIndex, 0, item);
                    renderCreatorGrid(); 
                }
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ˆå¢åŠ å‹ç¼©å¤„ç†ï¼‰
        async function handleFileSelect(input) {
            const files = Array.from(input.files);
            if (selectedImages.length + files.length > 10) {
                alert("æœ€å¤šåªèƒ½ä¸Šä¼  10 å¼ å›¾ç‰‡ï¼Œè¯·é‡æ–°é€‰æ‹©");
                return;
            }

            toggleLoading(true);

            for (const file of files) {
                try {
                    const compressedBlob = await compressImage(file, 0.85);
                    
                    const uniqueId = Date.now() + Math.random();
                    selectedImages.push({
                        id: uniqueId,
                        file: compressedBlob, 
                        url: URL.createObjectURL(compressedBlob), 
                        text: '' 
                    });
                } catch (e) {
                    console.error("å›¾ç‰‡å‹ç¼©å¤±è´¥:", e);
                    alert(`æ–‡ä»¶ ${file.name} å‹ç¼©å¤±è´¥ï¼Œå·²è·³è¿‡ã€‚`);
                }
            }
            
            toggleLoading(false);
            input.value = ''; 
            renderCreatorGrid();
        }

        // æ¸²æŸ“å‡ºé¢˜ç½‘æ ¼ (ä¸å˜)
        function renderCreatorGrid() {
            const container = document.getElementById('creator-grid');
            container.innerHTML = '';

            selectedImages.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'upload-card';
                div.innerHTML = `
                    <div class="thumb-box">
                        <div class="index-badge">${index + 1}</div>
                        <div class="delete-btn" onclick="removeImage(${index})">Ã—</div>
                        <img src="${item.url}">
                    </div>
                    <div class="input-area">
                        <input type="text" placeholder="ç­”æ¡ˆ/è¯´æ˜ (å¯é€‰)" value="${item.text}" oninput="updateText(${index}, this.value)">
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('status-bar').innerText = `å½“å‰å·²é€‰ ${selectedImages.length} å¼  (æœ€å°‘3å¼ ï¼Œæœ€å¤š10å¼ )`;
        }

        // åˆ é™¤æŸå¼ å›¾ (å…¨å±€è®¿é—®)
        window.removeImage = function(index) {
            selectedImages.splice(index, 1);
            renderCreatorGrid();
        }

        // æ›´æ–°æ–‡å­—è¾“å…¥ (å…¨å±€è®¿é—®)
        window.updateText = function(index, val) {
            selectedImages[index].text = val;
        }

        // æäº¤åˆ›å»º (V9 æœ€ç»ˆåŒ¿åç‰ˆ)
        async function createGame() {
            const title = document.getElementById('game-title').value || "æœªå‘½åæ¸¸æˆ";
            if (selectedImages.length < 3) return alert("è¯·è‡³å°‘ä¸Šä¼ 3å¼ å›¾ç‰‡");

            toggleLoading(true);

            try {
                const uploadedContent = [];
                
                // V9 æ ¸å¿ƒï¼šä½¿ç”¨å…¬å¼€çš„ Anon Key ä½œä¸º Bearer Tokenï¼Œä»¥æ»¡è¶³ Storage API çš„æˆæƒè¦æ±‚
                const accessToken = SUPABASE_KEY; 
                
                // å¾ªç¯ä¸Šä¼ ï¼šä½¿ç”¨åŸç”Ÿ Fetch + FormData
                for (let i = 0; i < selectedImages.length; i++) {
                    const item = selectedImages[i];
                    
                    // V7 ä¼˜åŒ–ï¼šç»Ÿä¸€ä½¿ç”¨ JPEG æ ¼å¼
                    const fileExt = 'jpg'; 
                    const safePath = `${Date.now()}_${i}.${fileExt}`; 
                    
                    const formData = new FormData();
                    const safeAsciiFileName = `file_${i}.${fileExt}`;
                    // item.file æ˜¯å‹ç¼©åçš„ Blob
                    formData.append('file', item.file, safeAsciiFileName); 
                    
                    const storageUrl = `${SUPABASE_URL}/storage/v1/object/game-images/${safePath}`;

                    // å‘é€è¯·æ±‚ï¼šä½¿ç”¨ Anon Key è¿›è¡Œæˆæƒ
                    const response = await fetch(storageUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`, 
                            'x-upsert': 'false', 
                            'cache-control': 'max-age=3600'
                        },
                        body: formData 
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(`Storage API Error (${response.status}): ${errData.message || response.statusText}`);
                    }

                    // è·å–é“¾æ¥
                    const { data: { publicUrl } } = supabase.storage.from('game-images').getPublicUrl(safePath);
                    
                    uploadedContent.push({
                        id: i,
                        url: publicUrl,
                        text: item.text,
                        correctIndex: i
                    });
                }

                // å­˜å…¥æ•°æ®åº“ (ä½¿ç”¨ Anon æƒé™å†™å…¥)
                const { data, error } = await supabase.from('quizzes')
                    .insert([{ 
                        title: title, 
                        game_type: 'sort', 
                        content: uploadedContent 
                    }])
                    .select();

                if (error) throw error;

                // ç»™å‡ºå…¬ç½‘åˆ†äº«é“¾æ¥
                const shareUrl = `${location.origin}${location.pathname}?id=${data[0].id}`;
                prompt("ğŸ‰ æ¸¸æˆåˆ›å»ºæˆåŠŸï¼å¤åˆ¶å…¬ç½‘é“¾æ¥å‘ç»™æœ‹å‹ï¼š", shareUrl);
                
            } catch (err) {
                console.error("åˆ›å»ºå¤±è´¥çš„è¯¦ç»†é”™è¯¯:", err);
                alert(`åˆ›å»ºå¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼š1. æ˜¯å¦è¿è¡Œäº†æœ€æ–°çš„ SQL ç­–ç•¥ï¼› 2. è¯¦ç»†é”™è¯¯ï¼š${err.message}`);
            } finally {
                toggleLoading(false);
            }
        }


        // === ç©å®¶é€»è¾‘ (V6/V9 ä¿®å¤ç‰ˆï¼Œç¡®ä¿å‡½æ•°å®šä¹‰å®Œæ•´) ===
        let sortableInstance;
        async function loadGame(id) {
            document.getElementById('creator-panel').classList.add('hidden');
            toggleLoading(true);
            
            // ç©å®¶æ¨¡å¼åªéœ€è¦ SELECT (è¯»å–) æƒé™ï¼Œä¸éœ€è¦ç™»å½•
            const { data, error } = await supabase.from('quizzes').select('*').eq('id', id).single();
            toggleLoading(false);

            if (error) return alert("æ¸¸æˆä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®");

            document.getElementById('player-panel').classList.remove('hidden');
            document.getElementById('play-title').innerText = data.title;
            
            // æ‰“ä¹±é¡ºåº
            let items = data.content;
            items.sort(() => Math.random() - 0.5);
            
            const container = document.getElementById('game-area');
            container.innerHTML = ''; 
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'game-item';
                div.dataset.correctIndex = item.correctIndex;
                div.innerHTML = `<img src="${item.url}">`;
                container.appendChild(div);
            });

            sortableInstance = new Sortable(container, { animation: 150 });
        }

        function submitAnswer() {
            const divs = document.querySelectorAll('.game-item');
            let correct = 0;
            divs.forEach((div, index) => {
                if (parseInt(div.dataset.correctIndex) === index) {
                    div.classList.add('correct');
                    correct++;
                } else {
                    div.classList.add('wrong');
                }
            });
            
            const isAllCorrect = correct === divs.length;
            const msg = document.getElementById('result-msg');
            msg.innerHTML = isAllCorrect ? "ğŸ‰ å…¨å¯¹ï¼" : `âŒ åªæœ‰ ${correct} ä¸ªä½ç½®æ˜¯å¯¹çš„`;
            msg.style.color = isAllCorrect ? "green" : "red";
            
            if(!isAllCorrect) document.getElementById('retry-btn').classList.remove('hidden');
            sortableInstance.option("disabled", true);
            document.getElementById('submit-btn').classList.add('hidden');
        }

        function retryGame() {
            document.querySelectorAll('.game-item').forEach(d => d.classList.remove('correct', 'wrong'));
            document.getElementById('retry-btn').classList.add('hidden');
            document.getElementById('submit-btn').classList.remove('hidden');
            document.getElementById('result-msg').innerHTML = '';
            sortableInstance.option("disabled", false);
            // æ¢å¤åŸå§‹æ‰“ä¹±çŠ¶æ€
            loadGame(gameId);
        }
    </script>
</body>
</html>